version: 1
applications:
  - appRoot: Apps/Web/arellsstore
    frontend:
      phases:
        preBuild:
          commands:
            - echo "üîß Setting up Volta for Node & Yarn..."
            - curl https://get.volta.sh | bash
            - export VOLTA_HOME="$HOME/.volta"
            - export PATH="$VOLTA_HOME/bin:$PATH"
            - volta install node@20.11.1
            - volta install yarn@1.22.22
            - node -v
            - yarn -v

            - |
              echo "üîç Validating required environment variables..."
              REQUIRED_VARS=(
                ARELLS_PRIVATE_KEY
                COGNITO_USER_POOL_ID
                DYNAMODB_ACCESS_KEY_ID
                DYNAMODB_SECRET_ACCESS_KEY
                DYNAMODB_TABLE_NAME
                NEXTAUTH_SECRET
                NEXT_PUBLIC_AWS_ACCESS_KEY_ID
                NEXT_PUBLIC_AWS_REGION
                NEXT_PUBLIC_AWS_SECRET_ACCESS_KEY
                NEXT_PUBLIC_BASE_URL
                NEXT_PUBLIC_COINGECKO_API_KEY
                NEXT_PUBLIC_GRAPH_URL
                NEXT_PUBLIC_RPC_URL
                NEXT_PUBLIC_S3_BUCKET_NAME
              )
              for VAR in "${REQUIRED_VARS[@]}"; do
                if [ -z "${!VAR}" ]; then
                  echo "‚ùå ERROR: Missing required env var: $VAR"
                  exit 1
                else
                  echo "‚úÖ $VAR is set"
                fi
              done

            - echo "üì¶ Installing dependencies..."
            - yarn install
            - echo "üõ†Ô∏è Compiling Hardhat contracts..."
            - npx hardhat compile

        build:
          commands:
            - echo "üöÄ Building Next.js app..."
            - yarn run build

      artifacts:
        baseDirectory: .next
        files:
          - '**/*'

      cache:
        paths:
          - node_modules/**/*
